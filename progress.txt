# App Signals Implementation Progress

## SIG-101: SESSION_STARTED signal (DONE)
- Added `emitSignal` import to sessionStore.ts
- Emit SESSION_STARTED after startSession() completes (line 170)
- Added unit test verifying signal emission
- Updated mock in sessionStore.activeSinger.test.ts to include emitSignal + APP_SIGNALS

Files changed:
- src/stores/sessionStore.ts
- src/stores/sessionStore.test.ts
- src/stores/sessionStore.activeSinger.test.ts
- ralph/app-signals.json

All tests pass. Lint clean.

## SIG-102: SESSION_ENDED signal (DONE)
- Emit SESSION_ENDED at end of endSession() after state cleared and queue reset
- Signal emitted in success path only (errors throw)
- Added unit test following SESSION_STARTED test pattern

Files changed:
- src/stores/sessionStore.ts (line 198)
- src/stores/sessionStore.test.ts (new test)
- ralph/app-signals.json

All tests pass. Lint clean.

## SIG-103: HOSTING_STARTED signal (DONE)
- Emit HOSTING_STARTED after hostSession() set() call and log statement (line 684)
- Signal emitted only in success path (errors thrown before set())
- Added unit test verifying signal emission - needed to reset setHostedSession mock

Files changed:
- src/stores/sessionStore.ts
- src/stores/sessionStore.test.ts (new test)
- ralph/app-signals.json

All tests pass. Lint clean.

## SIG-104: HOSTING_STOPPED signal (DONE)
- Emit HOSTING_STOPPED at end of stopHosting() finally block (line 762)
- Signal emitted in both success AND error paths (per acceptance criteria)
- Placed in finally block so fires regardless of API call outcome
- Added 3 unit tests: success path, error path, skip when no hosted session

Files changed:
- src/stores/sessionStore.ts
- src/stores/sessionStore.test.ts (3 new tests)
- ralph/app-signals.json

All tests pass (483). Lint clean. TypeScript clean.

## SIG-105: QUEUE_ITEM_ADDED signal (DONE)
- Imported emitSignal and APP_SIGNALS in queueStore.ts
- Emit QUEUE_ITEM_ADDED after both addToQueue() and addToQueueNext() complete
- Signal fires after state update, before returning item
- Also emit in addToQueueNext() since it adds items to queue
- Created new test file queueStore.signals.test.ts with 3 tests
- Updated queueStore.fairQueue.test.ts mock to include emitSignal/APP_SIGNALS

Files changed:
- src/stores/queueStore.ts (import + 2 emit calls)
- src/stores/queueStore.signals.test.ts (new file - 3 tests)
- src/stores/queueStore.fairQueue.test.ts (mock update)
- ralph/app-signals.json

All tests pass (486). Lint clean. TypeScript clean.

## SIG-106: QUEUE_ITEM_REMOVED signal (DONE)
- Emit QUEUE_ITEM_REMOVED after removeFromQueue() state update completes
- Signal fires after set() call filters item out
- Added unit test in queueStore.signals.test.ts

Files changed:
- src/stores/queueStore.ts (1 emit call after removeFromQueue)
- src/stores/queueStore.signals.test.ts (1 new test)
- ralph/app-signals.json

All tests pass (487). Lint clean. TypeScript clean.

## SIG-107: SONG_STARTED signal (DONE)
- Imported emitSignal and APP_SIGNALS in playerStore.ts
- Emit SONG_STARTED in playVideo() after setIsPlaying(true) for both YouTube embed and yt-dlp modes
- Created new test file playerStore.signals.test.ts with 3 tests
- Tests cover: YouTube embed mode, yt-dlp mode, no-op when video has no youtubeId

Files changed:
- src/stores/playerStore.ts (import + 2 emit calls in playVideo)
- src/stores/playerStore.signals.test.ts (new file - 3 tests)
- ralph/app-signals.json

All tests pass (490). Lint clean. TypeScript clean.

## SIG-108: SONG_STOPPED signal (DONE)
- Created stopVideo() function in playerStore.ts that:
  - Checks if video is currently playing (currentVideo && isPlaying)
  - Sets isPlaying to false
  - Emits SONG_STOPPED signal
- Call stopVideo() at start of playVideo() to stop current video when switching to a new one
- Exported stopVideo from stores/index.ts
- Added 4 unit tests in playerStore.signals.test.ts:
  - Manual stop emits signal
  - No signal when no video playing
  - No signal when already paused
  - Signal emitted when switching videos (SONG_STOPPED then SONG_STARTED)

Files changed:
- src/stores/playerStore.ts (new stopVideo function, call in playVideo)
- src/stores/index.ts (export stopVideo)
- src/stores/playerStore.signals.test.ts (4 new tests)
- ralph/app-signals.json

All tests pass (494). Lint clean. TypeScript clean.

## SIG-201: SESSION_LOADED signal (DONE)
- Added SESSION_LOADED to APP_SIGNALS constant in appSignals.ts
- Added payload type to SignalPayloads interface (undefined)
- Emit SESSION_LOADED in sessionStore.loadSession() after all init (singers, active singer, queue, assignments, hosted session restore)
- Added test in appSignals.test.ts verifying signal name
- Added 2 unit tests in sessionStore.test.ts:
  - Verifies signal emits after loadSession with active session
  - Verifies signal NOT emitted when no active session

Files changed:
- src/services/appSignals.ts (signal def + payload type)
- src/services/appSignals.test.ts (signal name test)
- src/stores/sessionStore.ts (emit call line 150)
- src/stores/sessionStore.test.ts (2 new tests)
- ralph/app-signals.json

All tests pass (497). Lint clean. TypeScript clean.

## SIG-202: SINGERS_LOADED signal (DONE)
- Added SINGERS_LOADED to APP_SIGNALS constant in appSignals.ts
- Added payload type to SignalPayloads interface (undefined)
- Emit SINGERS_LOADED in sessionStore.loadSingers() after singers are loaded
- Added SESSION_LOADED and SINGERS_LOADED to test mock APP_SIGNALS
- Added 3 unit tests in sessionStore.test.ts:
  - Verifies signal emits after loadSingers with active session
  - Verifies signal NOT emitted when no active session
  - Verifies signal NOT emitted when loading fails

Files changed:
- src/services/appSignals.ts (signal def + payload type)
- src/stores/sessionStore.ts (emit call line 343)
- src/stores/sessionStore.test.ts (mock update + 3 new tests)
- ralph/app-signals.json

All tests pass (500). Lint clean. TypeScript clean.

## SIG-203: QUEUE_LOADED signal (DONE)
- Added QUEUE_LOADED to APP_SIGNALS constant in appSignals.ts
- Added payload type to SignalPayloads interface (undefined)
- Emit QUEUE_LOADED in queueStore.loadPersistedState() after queue/history loaded
- Signal emitted in all 3 cases: state loaded, no persisted state, error
- Added QUEUE_LOADED to queueStore.signals.test.ts mock
- Added 3 unit tests in queueStore.signals.test.ts:
  - Verifies signal emits after loadPersistedState loads state
  - Verifies signal emits when no persisted state exists
  - Verifies signal emits even when loadPersistedState fails
- Added SINGERS_LOADED and QUEUE_LOADED to appSignals.test.ts

Files changed:
- src/services/appSignals.ts (signal def + payload type)
- src/services/appSignals.test.ts (signal name tests)
- src/stores/queueStore.ts (3 emit calls in loadPersistedState)
- src/stores/queueStore.signals.test.ts (mock update + 3 new tests)
- ralph/app-signals.json

All tests pass (503). Lint clean. TypeScript clean.

## SIG-301: AUTH_INITIALIZED signal (DONE)
- Added AUTH_INITIALIZED to APP_SIGNALS constant in appSignals.ts
- Added payload type to SignalPayloads interface (boolean for isAuthenticated)
- Emit AUTH_INITIALIZED in authStore.initialize() in all exit paths:
  - Pending callback path: emit with current isAuthenticated state
  - No tokens path: emit false
  - Invalid tokens path: emit false
  - Success path: emit true
  - Error path: emit false
- Added AUTH_INITIALIZED to appSignals.test.ts signal name test
- Added 4 unit tests in authStore.test.ts:
  - Verifies signal emits false when no tokens stored
  - Verifies signal emits false when tokens are invalid
  - Verifies signal emits true when user is authenticated
  - Verifies signal emits false when initialization throws

Files changed:
- src/services/appSignals.ts (signal def + payload type)
- src/services/appSignals.test.ts (signal name test)
- src/stores/authStore.ts (5 emit calls in initialize)
- src/stores/authStore.test.ts (mock update + 4 new tests)
- ralph/app-signals.json

All tests pass (507). Lint clean. TypeScript clean.

## SIG-302: TOKENS_REFRESHED signal (DONE)
- Added TOKENS_REFRESHED to APP_SIGNALS constant in appSignals.ts
- Added payload type to SignalPayloads interface (undefined)
- Emit TOKENS_REFRESHED in authStore.refreshSession() after successful token refresh
- Signal NOT emitted if refresh fails, offline, or error
- Added TOKENS_REFRESHED to appSignals.test.ts signal name test
- Added TOKENS_REFRESHED to authStore.test.ts mock
- Added 4 unit tests in authStore.test.ts:
  - Verifies signal emits after successful token refresh
  - Verifies signal NOT emitted when token refresh fails
  - Verifies signal NOT emitted when offline
  - Verifies signal NOT emitted when refreshSession throws

Files changed:
- src/services/appSignals.ts (signal def + payload type)
- src/services/appSignals.test.ts (signal name test)
- src/stores/authStore.ts (1 emit call after fetchUserProfile in refreshSession)
- src/stores/authStore.test.ts (mock update + 4 new tests)
- ralph/app-signals.json

All tests pass (511). Lint clean. TypeScript clean.

## SIG-303: HOSTED_SESSION_UPDATED signal (DONE)
- Added HOSTED_SESSION_UPDATED to APP_SIGNALS constant in appSignals.ts
- Added import for SessionStats type from hostedSession.ts
- Added payload type to SignalPayloads interface (SessionStats)
- Emit HOSTED_SESSION_UPDATED in sessionStore.refreshHostedSession() after stats update
- Signal emitted with updated.stats payload after successful getSession call
- Signal NOT emitted if refresh fails or session is cleared
- Added HOSTED_SESSION_UPDATED to appSignals.test.ts signal name test
- Added HOSTED_SESSION_UPDATED to sessionStore.test.ts mock
- Added 3 unit tests in sessionStore.test.ts:
  - Verifies signal emits with stats after successful refresh
  - Verifies signal NOT emitted when refresh fails
  - Verifies signal NOT emitted when no hosted session exists

Files changed:
- src/services/appSignals.ts (import SessionStats, signal def + payload type)
- src/services/appSignals.test.ts (signal name test)
- src/stores/sessionStore.ts (1 emit call after stats update)
- src/stores/sessionStore.test.ts (mock update + 3 new tests)
- ralph/app-signals.json

All tests pass (514). Lint clean. TypeScript clean.

## SIG-401: PLAYBACK_STARTED/PAUSED/ENDED signals (DONE)
- Added PLAYBACK_STARTED, PLAYBACK_PAUSED, PLAYBACK_ENDED to APP_SIGNALS constant
- Added payload types to SignalPayloads interface (all undefined)
- Created 3 new functions in playerStore.ts:
  - pausePlayback(): pauses video, emits PLAYBACK_PAUSED
  - resumePlayback(): resumes video, emits PLAYBACK_STARTED
  - notifyPlaybackEnded(): emits PLAYBACK_ENDED
- Emit PLAYBACK_STARTED in playVideo() after SONG_STARTED (both YouTube/yt-dlp modes)
- Emit PLAYBACK_ENDED in VideoPlayer.handleEnded before SONG_ENDED
- Exported new functions from stores/index.ts
- Updated mock APP_SIGNALS in playerStore.signals.test.ts and VideoPlayer.handleEnded.test.tsx
- Added 8 unit tests in playerStore.signals.test.ts:
  - PLAYBACK_STARTED via playVideo
  - PLAYBACK_STARTED via resumePlayback
  - No signal when no video loaded (resumePlayback)
  - No signal when already playing (resumePlayback)
  - PLAYBACK_PAUSED via pausePlayback
  - No signal when no video playing (pausePlayback)
  - No signal when already paused (pausePlayback)
  - PLAYBACK_ENDED via notifyPlaybackEnded
- Added signal name tests to appSignals.test.ts
- Updated "switching video" test to expect 3 signals (SONG_STOPPED, SONG_STARTED, PLAYBACK_STARTED)

Files changed:
- src/services/appSignals.ts (3 signal defs + payload types)
- src/services/appSignals.test.ts (3 signal name tests)
- src/stores/playerStore.ts (3 new functions, 2 emit calls in playVideo)
- src/stores/index.ts (3 new exports)
- src/stores/playerStore.signals.test.ts (mock update + 8 new tests + 1 updated test)
- src/components/player/VideoPlayer.tsx (1 emit call in handleEnded)
- src/components/player/VideoPlayer.handleEnded.test.tsx (mock update)
- ralph/app-signals.json

All tests pass (522). Lint clean. TypeScript clean.

## SIG-402: VIDEO_METADATA_CHANGED signal (DONE)
- Added VIDEO_METADATA_CHANGED to APP_SIGNALS constant in appSignals.ts
- Added VideoMetadata interface (title, artist, duration, videoId)
- Added payload type to SignalPayloads interface (VideoMetadata)
- Added lastMetadataVideoId tracking in playerStore state
- Created emitVideoMetadataChanged() function that:
  - Compares current video ID to last emitted ID
  - Skips emit for same video (replay scenario)
  - Updates lastMetadataVideoId after emit
- Emit signal in playVideo() for both YouTube embed and yt-dlp modes
- Exported VideoMetadata type from services/index.ts
- Added VIDEO_METADATA_CHANGED to appSignals.test.ts signal name test
- Updated playerStore.signals.test.ts mock with VIDEO_METADATA_CHANGED
- Added lastMetadataVideoId to test state reset
- Added 5 unit tests:
  - Signal emits when new video played
  - Signal emits via emitVideoMetadataChanged direct call
  - Signal NOT emitted for same video replay
  - Signal emits when switching to different video
  - Uses id as videoId when youtubeId not available
- Updated "switching video" test to expect 4 signals (now includes VIDEO_METADATA_CHANGED)

Files changed:
- src/services/appSignals.ts (signal def + VideoMetadata interface + payload type)
- src/services/appSignals.test.ts (signal name test)
- src/services/index.ts (export VideoMetadata)
- src/stores/playerStore.ts (lastMetadataVideoId state, emitVideoMetadataChanged fn, 2 emit calls)
- src/stores/playerStore.signals.test.ts (mock update + 5 new tests + 1 updated test)
- ralph/app-signals.json

All tests pass (527). Lint clean. TypeScript clean.

## SIG-403: QUEUE_ORDER_CHANGED and NEXT_SONG_CHANGED signals (DONE)
- Added QUEUE_ORDER_CHANGED and NEXT_SONG_CHANGED to APP_SIGNALS constant
- Added NextSongPayload interface (nextItemId, nextVideoId)
- Added payload types to SignalPayloads interface
- Exported NextSongPayload from services/index.ts
- Created emitNextSongChangedIfDifferent() helper function in queueStore.ts
- Emit QUEUE_ORDER_CHANGED in reorderQueue() and fairShuffle()
- Emit NEXT_SONG_CHANGED in multiple queueStore functions when first item changes:
  - addToQueue (if queue was empty or fair position was 0)
  - addToQueueNext (always, since new item is first)
  - removeFromQueue (if removed item was first)
  - reorderQueue (via helper)
  - clearQueue (if queue had items)
  - fairShuffle (via helper)
  - playFromQueue (if played item was first)
  - playNext (first item consumed from queue)
  - playNextFromQueue (first item consumed from queue)
  - moveAllHistoryToQueue (if queue was empty)
- Added signal name tests to appSignals.test.ts

Files changed:
- src/services/appSignals.ts (signal defs + NextSongPayload interface + payload types)
- src/services/appSignals.test.ts (signal name tests)
- src/services/index.ts (export NextSongPayload)
- src/stores/queueStore.ts (helper fn + emit calls in 10 functions)
- ralph/app-signals.json

All tests pass (527). Lint clean. TypeScript clean.

---

## SIG-501: Add QUEUE_OPERATION_FAILED signal for error broadcasting

Task: Add signal for critical queue operation failures.

Changes:
- Added QUEUE_OPERATION_FAILED to APP_SIGNALS constant
- Added QueueOperationFailedPayload interface with `operation` and `message` fields
- Operation type enum: moveAllHistoryToQueue, addToQueue, removeFromQueue, reorderQueue, clearQueue, fairShuffle
- Emit signal in queueStore.moveAllHistoryToQueue() on rollback failure
- Added unit test for QUEUE_OPERATION_FAILED emission
- Exported QueueOperationFailedPayload from services/index.ts

Files changed:
- src/services/appSignals.ts (signal def + payload interface + payload type)
- src/services/appSignals.test.ts (signal name test + emission test)
- src/services/index.ts (export QueueOperationFailedPayload)
- src/stores/queueStore.ts (emit signal on moveAllHistoryToQueue rollback)
- ralph/app-signals.json (marked SIG-501 passes: true)

All tests pass (528). Lint clean. TypeScript clean.

## SIG-502: Add HOSTING_ERROR signal for error broadcasting

Task: Add signal for hosting operation failures.

Changes:
- Added HOSTING_ERROR to APP_SIGNALS constant
- Added HostingErrorPayload interface with `operation` and `message` fields
- Operation type enum: hostSession, stopHosting, refreshHostedSession, restoreHostedSession
- Emit signal in sessionStore in 4 locations:
  - hostSession() catch block before rethrowing error
  - stopHosting() when apiCallFailed is true (after notify)
  - refreshHostedSession() catch block
  - restoreHostedSession() catch block (silent cleanup scenario)
- Added unit test for HOSTING_ERROR emission
- Exported HostingErrorPayload from services/index.ts

Files changed:
- src/services/appSignals.ts (signal def + payload interface + payload type)
- src/services/appSignals.test.ts (signal name test + emission test)
- src/services/index.ts (export HostingErrorPayload)
- src/stores/sessionStore.ts (4 emit calls on hosting failures)
- ralph/app-signals.json (marked SIG-502 passes: true)

All tests pass (529). Lint clean. TypeScript clean.

---

## SIG-503: MIGRATION_COMPLETE signal after legacy migration

Added MIGRATION_COMPLETE signal for legacy hosted session migration coordination.

Key decisions:
- Signal emitted via .finally() to ensure it fires in both success and error cases
- Payload is undefined (just signals migration was attempted)
- Signal allows future code to wait until migration runs before proceeding

Files changed:
- src/services/appSignals.ts (added MIGRATION_COMPLETE signal + payload type)
- src/services/appSignals.test.ts (added signal name test + emission test)
- src/App.tsx (emit signal in .finally() after runLegacyHostedSessionMigration)
- ralph/app-signals.json (marked SIG-503 passes: true)

All tests pass (530). Lint clean. TypeScript clean.

---

## SIG-601: Add YTDLP_AVAILABLE/UNAVAILABLE signals

**Completed**: Added yt-dlp availability signals to app signal system.

**Changes**:
- src/services/appSignals.ts: Added YTDLP_AVAILABLE and YTDLP_UNAVAILABLE to APP_SIGNALS constant, added undefined payload types to SignalPayloads interface
- src/stores/settingsStore.ts: Import emitSignal/APP_SIGNALS, emit YTDLP_AVAILABLE on success or YTDLP_UNAVAILABLE on failure/error in checkYtDlpAvailability()
- src/services/appSignals.test.ts: Added tests for new signal names and emission tests
- ralph/app-signals.json: Marked SIG-601 passes: true

**Key decisions**:
- Signal emitted in 3 places: cached result from DB, fresh check success, fresh check error
- Used void emitSignal() pattern (fire-and-forget) consistent with other signal emissions
- No payload needed (boolean availability is stored in state already)

All tests pass (532). Lint clean. TypeScript clean.
